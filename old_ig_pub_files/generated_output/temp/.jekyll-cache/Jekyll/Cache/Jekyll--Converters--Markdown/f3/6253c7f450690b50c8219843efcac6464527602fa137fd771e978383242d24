I"ùV<!-- TOC  the css styling for this is \pages\assets\css\project.css under 'markdown-toc'-->

<ul id="markdown-toc">
  <li><a href="#r24-server-architecture" id="markdown-toc-r24-server-architecture">R24 Server Architecture</a></li>
  <li><a href="#smart-app-workflow" id="markdown-toc-smart-app-workflow">Smart app Workflow</a></li>
</ul>

<!-- end TOC -->

<h3 id="r24-server-architecture">R24 Server Architecture</h3>

<!-- all this Bootstrap html for getting an image to fit nicely in text - 640 pix wide -->

<!-- file:///assets/images/R24_Overview2.jpg -->

<div>
<figure class="figure">
<figcaption class="figure-caption"><strong></strong></figcaption>
  <img src="assets/images/R24_Overview2.jpg" class="figure-img-portrait img-responsive img-rounded center-block" alt="R24_Overview2.jpg" />
</figure>

<p></p>
</div>

<p><strong>FHIR-enabled EHR system</strong></p>

<ul>
  <li>A <em>Open mHealth to FHIR Server</em> with FHIR server running SMART-on-FHIR protocols for authentication/authorization, etc.</li>
  <li>Patient‚Äôs step counter sensor (called ** StepSensor** in this use case) ‚Äì specific product, may be the patient‚Äôs phone</li>
  <li>Data store for the Step-Counter output (e.g., cloud and/or phone (e.g., GoogleFit, HealthKit)) that either offers data directly in - Open mHealth format using an Open mHealth endpoint, or is supported by <em>Shimmer</em> or <em>Granola</em></li>
  <li>OmH-on-FHIR Client a SMART on FHIR app ‚Äì has roles for PCP, onboarding staff, and patient</li>
</ul>

<hr />

<h3 id="smart-app-workflow">Smart app Workflow</h3>

<h4 class="no_toc" id="retrieving-omh-data-in-native-omh-schema-format">Retrieving OMH data in native OMH Schema format</h4>

<!-- all this Bootstrap html for getting an narrow image to fit nicely in text - 640 pix wide -->

<!-- file:///assets/images/smartapp-binary.png -->

<div>
<figure class="figure">
<figcaption class="figure-caption"><strong></strong></figcaption>
  <img src="assets/images/smartapp-binary.png" class="figure-img img-responsive img-rounded center-block" alt="smartapp-binary.png" />
</figure>

<p></p>
</div>

<table class="grid">
  <thead>
    <tr>
      <th>Step</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1.</td>
      <td>Smart app Launch from Provider EHR. See the <a href="http://docs.smarthealthit.org/authorization/" title="SMART App Authorization Guide">Smart on FHIR Launch</a> Specification</td>
    </tr>
    <tr>
      <td>2.</td>
      <td>R24 server authenticates and authorizes app to get OMH data</td>
    </tr>
    <tr>
      <td>3.</td>
      <td>Following successful launch, the Smart app request OMH step count data for patient Z as a standard <a href="http://hl7.org/fhir/R4/search.html" title="FHIR search API documentation">FHIR search API</a> on <em><a href="http://hl7.org/fhir/R4/documentreference.html" title="FHIR DocumentReference Resource documentation">DocumentReference</a></em>. It provides an opaque identifier as a search parameter that identifies patient Z and optionally a time range of interest.</td>
    </tr>
    <tr>
      <td>4.</td>
      <td>The R24 server receives the request and either maps the opaque id to its user id list and creates the DocumentReference resource on the fly from a native format or searches its FHIR based datastore for DocumentReference matches.  Note that the DocumentReference is a ‚Äòwrapper‚Äô and contains context and a link to a <a href="http://hl7.org/fhir/R4/binary.html" title="FHIR Binary Resource documentation">Binary</a> resource that represents the actual OMH Step Count data.</td>
    </tr>
    <tr>
      <td>5.</td>
      <td>The R24 server returns DocumentReference resources that match the search criteria</td>
    </tr>
    <tr>
      <td>6.</td>
      <td>The smart app receives the DocumentReference resource(s) and processes them one by one extracting the Binary endpoint data. then makes a second request to fetch the Binary resources in the native OMH (json) format using the standard <a href="http://hl7.org/fhir/R4/binary.html#rest" title="FServing Binary Resources using the RESTful API">FHIR API for Binary data</a> (Note that the data may also be requested as a base64 encoded string as well).</td>
    </tr>
    <tr>
      <td>8.</td>
      <td>The R24 server receives the request for the OMH data in the native JSON format.</td>
    </tr>
    <tr>
      <td>9.</td>
      <td>For successful matches, the R24 Server Return the native OMH JSON file</td>
    </tr>
    <tr>
      <td>10.</td>
      <td>processes/displays the OMH data to the end user</td>
    </tr>
  </tbody>
</table>

<h5 class="no_toc" id="example">Example</h5>

<h6 class="no_toc" id="launch-smart-on-fhir-app-steps-1-and-2">Launch Smart on FHIR App (Steps 1 and 2).</h6>

<table>
  <tbody>
    <tr>
      <td>See the <a href="http://docs.smarthealthit.org/authorization/" title="SMART App Authorization Guide">Smart on FHIR Launch</a> Specification</td>
      <td>for examples</td>
    </tr>
  </tbody>
</table>

<h6 class="no_toc" id="fetch-fhir-documentreference-resources-containing-omh-step-count-data--steps-3-6">Fetch FHIR DocumentReference resources containing OMH step count data.  (Steps 3-6)</h6>

<p>Includes: Opaque patient identifier, date Range, OMH datapoint common name,  OMH datapoint schema standard codes</p>

<table class="grid">
  <thead>
    <tr>
      <th>Details</th>
      <th>URL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OMH Specification</td>
      <td><a href="http://www.openmhealth.org/schemas/omh_step-count">http://www.openmhealth.org/schemas/omh_step-count</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 DocumentReference Resource</td>
      <td><a href="http://hl7.org/fhir/STU3/documentreference.html">http://hl7.org/fhir/STU3/documentreference.html</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 Search API</td>
      <td><a href="http://hl7.org/fhir/STU3/search.html">http://hl7.org/fhir/STU3/search.html</a></td>
    </tr>
  </tbody>
</table>

<p><strong>Request</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /DocumentReference/?patient.identifier={identifier}

Content-type: application/json+fhir
Accept: application/json+fhir
...other headers...
</code></pre></div></div>

<p><strong>Issues</strong></p>
<ol>
  <li>Assumed identifiers as ‚Äòlogical‚Äô (opaque Identifiers) and not ‚Äòliteral‚Äô reference to Patient resource (see http://hl7.org/fhir/STU3/references.html.
    <ol>
      <li>using a <a href="http://hl7.org/fhir/R4/references#contained.html" title="FHIR contained resource documentation">contained</a> patient resource to hold the identifier to allow for searching by the identifier as ‚Äòchained‚Äô search.</li>
      <li>need to assign system  ( e.g UUID, or https://omh.r24server/ids )</li>
    </ol>
  </li>
</ol>

<!--
https://vonk.furore.com/DocumentReference?patient=1.3.6.1.4.1.21367.2005.3.7.1234
-->

<p><strong>Response</strong></p>

<p>
  <button class="btn btn-info btn-lg btn-block" type="button" title="Click to Open or Close Example" data-toggle="collapse" data-target="#get_omh_schema_dr_response_example" aria-expanded="false" aria-controls="collapseExample">
    Response to `GET /DocumentReference/?...`
  </button>
</p>

<div class="collapse" id="get_omh_schema_dr_response_example">
  <div class="card card-body">
      
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Date: Tue, 22 May 2018 03:40:05 GMT
Content-Type: application/fhir+json; charset=utf-8
...other headers...

{
    "resourceType": "Bundle",
    "id": "d3334394-5e24-49d4-b8a2-d0fc004a69",
    "meta": {
        "lastUpdated": "2018-05-24T00:18:35Z"
    },
    "type": "searchset",
    "total": 1,
    "link": [
        {
            "relation": "self",
            "url": "http://test.fhir.org/r3/DocumentReference?_format=application/fhir+json&amp;search-id=901a685f-a483-4e92-8a6e-fb3e14cbfc&amp;&amp;patient.identifier=some%2Duser&amp;_sort=_id"
        }
    ],
    "entry": [
        {
            "fullUrl": "http://test.fhir.org/r3/DocumentReference/omh-stepcount-example",
            "resource": {
                "resourceType": "DocumentReference",
                "id": "omh-stepcount-example",
                "meta": {
                    "versionId": "4",
                    "lastUpdated": "2018-05-23T23:14:29Z"
                },
                "contained": [
                    {
                        "resourceType": "Patient",
                        "id": "p",
                        "identifier": [
                            {
                                "system": "https://omh.org/shimmer/patient_ids",
                                "value": "some-user"
                            }
                        ]
                    }
                ],
                "identifier": [
                    {
                        "system": "urn:ietf:rfc:3986",
                        "value": "urn:oid:1.3.6.1.4.1.21367.2005.3.7.1234"
                    }
                ],
                "status": "current",
                "type": {
                    "coding": [
                        {
                            "system": "http://loinc.org",
                            "code": "55423-8",
                            "display": "Step Count"
                        }
                    ]
                },
                "class": {
                    "text": "OMH schema data"
                },
                "subject": {
                    "reference": "#p"
                },
                "created": "2018-05-22T09:35:00+11:00",
                "indexed": "2018-05-22T09:35:00+11:00",
                "content": [
                    {
                        "attachment": {
                            "contentType": "application/json",
                            "url": "http://test.fhir.org/r3/Binary/omh-stepcount-example"
                        }
                    }
                ],
                "context": {
                    "period": {
                        "start": "2018-05-23T08:00:00+11:00",
                        "end": "2018-05-23T08:01:00+11:00"
                    }
                }
            },
            "search": {
                "mode": "match"
            }
        }
    ]
}
</code></pre></div></div>

  </div>
</div>
<p><br /></p>

<p><strong>Issues</strong></p>

<ol>
  <li>Need to assign classes and types codes to identify.
    <ol>
      <li>need to assign system  ( e.g OMH )</li>
    </ol>
  </li>
  <li>Need to decide how much context to repeat here vs in OMH Schema data
    <ol>
      <li>min date range and type of datatpoint</li>
    </ol>
  </li>
</ol>

<h6 class="no_toc" id="fetch-native-omh-step-count-data--steps-7-10">Fetch native OMH step count data.  (Steps 7-10)</h6>

<p>Includes: Binary id(s)</p>

<table class="grid">
  <thead>
    <tr>
      <th>Details</th>
      <th>URL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OMH Specification</td>
      <td><a href="http://www.openmhealth.org/schemas/omh_step-count">http://www.openmhealth.org/schemas/omh_step-count</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 Binary Resource</td>
      <td><a href="http://hl7.org/fhir/STU3/binary.html">http://hl7.org/fhir/STU3/binary.html</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 REST API</td>
      <td><a href="http://hl7.org/fhir/STU3/html.html">http://hl7.org/fhir/STU3/html.html</a></td>
    </tr>
  </tbody>
</table>

<p><strong>Request</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /Binary/{id} or GET /Binary?_id={id}

Accept and Application-type headers absent!
...Other headers...
</code></pre></div></div>

<p><strong>Response</strong></p>

<p>
  <button class="btn btn-info btn-lg btn-block" type="button" title="Click to Open or Close Example" data-toggle="collapse" data-target="#get_omh_schema_binary_response_example" aria-expanded="false" aria-controls="collapseExample">
    Response to `GET /Binary/{id}`
  </button>
</p>

<div class="collapse" id="get_omh_schema_binary_response_example">
  <div class="card card-body">
      
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Connection: close
Content-Type: application/json
...Other Headers...

{
  "header": {
    "id": "243c773b-8936-407e-9c23-270d0ea49cc4",
    "creation_date_time": "2015-09-10T12:43:39.138-06:00",
    "acquisition_MedicationDispense": {
      "source_name": "Jawbone UP API",
      "modality": "sensed",
      "source_updated_date_time": "2015-09-10T18:43:39Z"
    },
    "schema_id": {
      "namespace": "omh",
      "name": "step-count",
      "version": "1.0"
    },
    "user_id": "306a1202-410d-11e8-842f-0ed5f89f718b"
  },
  "body": {
    "effective_time_frame": {
      "time_interval": {
        "start_date_time": "2015-08-06T05:11:09-07:00",
        "end_date_time": "2015-08-06T23:00:36-06:00"
      }
    },
    "step_count": 7939
  }
}
</code></pre></div></div>

  </div>
</div>
<p><br /></p>

<p><strong>Issues:</strong></p>

<ol>
  <li>Fetching multiple files
    <ol>
      <li>not specified  - may want an operation to zip into folder see this <a href="https://chat.fhir.org/#narrow/stream/4-implementers/topic/Requesting.20multiple.20Binary.20Resources">Zulip Chat</a>?</li>
    </ol>
  </li>
  <li>‚Ä¶</li>
</ol>

<hr />

<h4 class="no_toc" id="retrieving-omh-data-as-fhir-observations">Retrieving OMH data as FHIR Observations</h4>

<!-- all this Bootstrap html for getting an narrow image to fit nicely in text - 640 pix wide -->

<!-- file:///assets/images/smartapp-observation.png -->

<div>
<figure class="figure">
<figcaption class="figure-caption"><strong></strong></figcaption>
  <img src="assets/images/smartapp-observation.png" class="figure-img img-responsive img-rounded center-block" alt="smartapp-observation.png" />
</figure>

<p></p>
</div>

<table class="grid">
  <thead>
    <tr>
      <th>Step</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1.</td>
      <td>Smart app Launch from Provider EHR</td>
    </tr>
    <tr>
      <td>2.</td>
      <td>R24 server authenticates and authorizes app to get OMH data</td>
    </tr>
    <tr>
      <td><mark>3.</mark></td>
      <td><mark>Following successful launch, the Smart app request OMH step count data for patient Z as a standard FHIR search API on *Observation*.  It provides an opaque identifier as a search parameter that identifies patient Z and optionally a time range of interest.</mark></td>
    </tr>
    <tr>
      <td><mark>4.</mark></td>
      <td><mark>The R24 server receives the request and either maps the opaque id to its user id list and maps the OMH step count schemas to Observation on the fly from a native format or searches its FHIR based datastore for matches.</mark></td>
    </tr>
    <tr>
      <td><mark>5.</mark></td>
      <td><mark>R24 server returns Observation resources that match the search criteria</mark></td>
    </tr>
    <tr>
      <td><mark>6.</mark></td>
      <td><mark>The smart app receives the Observation resource(s) and</mark></td>
    </tr>
    <tr>
      <td>7.</td>
      <td>processes/displays the OMH data to the end user</td>
    </tr>
  </tbody>
</table>

<h5 class="no_toc" id="example-1">Example</h5>

<h6 class="no_toc" id="launch-smart-on-fhir-app-steps-1-and-2-1">Launch Smart on FHIR App (Steps 1 and 2)</h6>

<table>
  <tbody>
    <tr>
      <td>See the <a href="http://docs.smarthealthit.org/authorization/" title="SMART App Authorization Guide">Smart on FHIR Launch</a> Specification</td>
      <td>for examples</td>
    </tr>
  </tbody>
</table>

<h6 class="no_toc" id="fetch-fhir-observation-representing-the-omh-step-count-data--steps-3-6">Fetch FHIR Observation representing the OMH step count data.  (Steps 3-6)</h6>

<p>Includes: Opaque patient identifer, date range, OMH data type as code</p>

<table class="grid">
  <thead>
    <tr>
      <th>Details</th>
      <th>URL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OMH Specification</td>
      <td><a href="http://www.openmhealth.org/schemas/omh_step-count">http://www.openmhealth.org/schemas/omh_step-count</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 Observation Resource</td>
      <td><a href="http://hl7.org/fhir/STU3/documentreference.html">http://hl7.org/fhir/STU3/documentreference.html</a></td>
    </tr>
    <tr>
      <td>FHIR STU3 Search API</td>
      <td><a href="http://hl7.org/fhir/STU3/search.html">http://hl7.org/fhir/STU3/search.html</a></td>
    </tr>
  </tbody>
</table>

<p><strong>Request</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET Observation?patient.identifier={identifier}&amp;code=55423-8

Content-type: application/json+fhir
Accept: application/json+fhir
...other headers...
</code></pre></div></div>

<p><strong>Issues</strong></p>

<ol>
  <li>Assumed identifiers as ‚Äòlogical‚Äô (opaque Identifiers) and not ‚Äòliteral‚Äô reference to Patient resource (see http://hl7.org/fhir/STU3/references.html.
    <ol>
      <li>using a <a href="http://hl7.org/fhir/R4/references#contained.html" title="FHIR contained resource documentation">contained</a> patient resource to hold the identifier to allow for searching by the identifier as ‚Äòchained‚Äô search.</li>
      <li>need to assign system  ( e.g UUID, or https://omh.r24server/ids )</li>
    </ol>
  </li>
  <li>Using code to identify datapoint schema</li>
  <li>search by max and min and other parameters</li>
  <li>provenance?</li>
</ol>

<p><strong>Response</strong></p>

<p>
  <button class="btn btn-info btn-lg btn-block" type="button" title="Click to Open or Close Example" data-toggle="collapse" data-target="#get_fhir_resource_response_example" aria-expanded="false" aria-controls="collapseExample">
    Response to `GET Observation?...`
  </button>
</p>

<div class="collapse" id="get_fhir_resource_response_example">
  <div class="card card-body">
      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Connection: close
Content-Type: application/json
...Other Headers...

{
    "resourceType": "Bundle",
    "id": "55f690f4-d5e5-4f26-8fa2-026be61019",
    "meta": {
        "lastUpdated": "2018-05-23T23:48:12Z"
    },
    "type": "searchset",
    "total": 1,
    "link": [
        {
            "relation": "self",
            "url": "http://test.fhir.org/r3/Observation?_format=application/fhir+json&amp;search-id=7db95351-c995-4cbc-b990-1760a91987&amp;&amp;patient.identifier=some%2Duser&amp;_sort=_id"
        }
    ],
    "entry": [
        {
            "fullUrl": "http://test.fhir.org/r3/Observation/stepcount-example",
            "resource": {
                "resourceType": "Observation",
                "id": "stepcount-example",
                "meta": {
                    "versionId": "5",
                    "lastUpdated": "2018-05-23T21:56:09Z"
                },
                "contained": [
                    {
                        "resourceType": "Patient",
                        "id": "p",
                        "identifier": [
                            {
                                "system": "https://omh.org/shimmer/patient_ids",
                                "value": "some-user"
                            }
                        ]
                    }
                ],
                "identifier": [
                    {
                        "system": "https://omh.org/shimmer/ids",
                        "value": "12341567"
                    }
                ],
                "status": "unknown",
                "category": [
                    {
                        "coding": [
                            {
                                "system": "http://snomed.info/sct",
                                "code": "68130003",
                                "display": "Physical activity (observable entity)"
                            }
                        ]
                    }
                ],
                "code": {
                    "coding": [
                        {
                            "system": "http://loinc.org",
                            "code": "55423-8",
                            "display": "Number of steps in unspecified time Pedometer"
                        }
                    ],
                    "text": "Step count"
                },
                "subject": {
                    "reference": "#p"
                },
                "effectivePeriod": {
                    "start": "2018-04-17T00:00:00Z",
                    "end": "2018-04-24T00:00:00Z"
                },
                "issued": "2018-04-24T17:13:50Z",
                "device": {
                    "display": "Jawbone UP API, modality =sensed, sourceCreationDateTime = 2018-04-17T17:13:50Z"
                },
                "component": [
                    {
                        "code": {
                            "coding": [
                                {
                                    "system": "http://hl7.org/fhir/observation-statistics",
                                    "code": "maximum",
                                    "display": "Maximum"
                                }
                            ],
                            "text": "Maximum"
                        },
                        "valueQuantity": {
                            "value": 7939,
                            "unit": "steps/day",
                            "system": "http://unitsofmeasure.org",
                            "code": "{steps}/d"
                        }
                    }
                ]
            },
            "search": {
                "mode": "match"
            }
        }
    ]
}
</code></pre></div></div>

  </div>
</div>
<p><br /></p>

<p>To view this API in action using the Postman Collection Runner import this <a href=":https://www.getpostman.com/collections/0a54cd0197a5f2fc98d4">Postman Collection</a>.</p>

<p><br /></p>

<hr />

:ET